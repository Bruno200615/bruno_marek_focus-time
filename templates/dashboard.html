{% extends "base.html" %}
{% block content %}
<div class="dashboard">
  <h1>Welcome, {{ username }}! üçÖ</h1>

  <audio id="clickSound" src="{{ url_for('static', filename='click.wav') }}"></audio>

  <input type="text" id="taskNote" placeholder="What are you working on?">

  <div class="pomodoro-container">
    <div class="progress-ring">
      <svg id="progressSvg" width="180" height="180">
        <circle cx="90" cy="90" r="80" stroke="#ccc" stroke-width="10" fill="none" />
        <circle id="progressCircle" cx="90" cy="90" r="80" stroke="#4CAF50" stroke-width="10" fill="none"
          stroke-dasharray="502" stroke-dashoffset="0" />
      </svg>
      <div class="timer" id="timer">25:00:000</div>
    </div>

    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="stopBtn" disabled>Stop</button>
      <button id="saveBtn" disabled>Save</button>
      <button id="resetBtn">Reset</button>
    </div>
  </div>

  <h2>Your Sessions</h2>
  {% if sessions %}
  <table>
    <thead>
      <tr>
        <th>Started At</th>
        <th>Ended At</th>
        <th>Duration</th>
        <th>Stops</th>
        <th>Note</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for s in sessions %}
      <tr>
        <td>{{ s.started_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td>
          {% if s.ended_at %}
            {{ s.ended_at.strftime('%Y-%m-%d %H:%M') }}
          {% else %}
            In Progress
          {% endif %}
        </td>
        <td>
          {% if s.ended_at %}
            {% set total = (s.ended_at - s.started_at).seconds %}
            {{ (total // 60)|string }}m {{ (total % 60)|string }}s
          {% else %}
            --:--:--
          {% endif %}
        </td>
        <td>{{ s.events|selectattr('event_type','equalto','stop')|list|length }}</td>
        <td>{{ s.note }}</td>
        <td>
          <button onclick="deleteSession('{{ s.id }}')">Delete</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>No sessions recorded yet.</p>
  {% endif %}

  <div id="chat-toggle">üí¨</div>
  <div id="chat-widget" class="hidden">
    <div id="chat-header">
      <span>Pomodoro Bot</span>
      <button id="chat-close">‚úï</button>
    </div>
    <div id="chat-log"></div>
    <div id="chat-input-area">
      <!-- Analyze button -->
      <button id="analyzeBtn">Analyze My Sessions</button>
      <input id="chat-input" placeholder="Ask me..." />
      <button id="chat-send">Send</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Timer setup
  let totalMs = 25 * 60 * 1000;
  let remainingMs = totalMs;
  let interval = null;
  let currentSessionId = null;

  const timerDisplay = document.getElementById('timer');
  const progressCircle = document.getElementById('progressCircle');
  const radius = 80;
  const circumference = 2 * Math.PI * radius;
  progressCircle.style.strokeDasharray = circumference;

  function updateTimerDisplay() {
    const m = Math.floor(remainingMs / 60000);
    const s = Math.floor((remainingMs % 60000) / 1000);
    const ms = remainingMs % 1000;
    timerDisplay.textContent = 
      `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}:${String(ms).padStart(3,'0')}`;
  }

  function updateProgressCircle() {
    const offset = circumference * (1 - remainingMs / totalMs);
    progressCircle.style.strokeDashoffset = offset;
  }

  function tick() {
    remainingMs = Math.max(0, remainingMs - 50);
    if (remainingMs === 0) clearInterval(interval);
    updateTimerDisplay();
    updateProgressCircle();
  }

  // Start
  document.getElementById('startBtn').onclick = async () => {
    document.getElementById('clickSound').play();
    if (!currentSessionId) {
      const res = await fetch('{{ url_for("session_start") }}', { method: 'POST' });
      const { session_id } = await res.json();
      currentSessionId = session_id;
    }
    if (!interval) interval = setInterval(tick, 50);
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('startBtn').disabled = true;
  };

  // Stop
  document.getElementById('stopBtn').onclick = async () => {
    document.getElementById('clickSound').play();
    clearInterval(interval); interval = null;
    await fetch('{{ url_for("session_stop") }}', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ session_id: currentSessionId })
    });
    document.getElementById('saveBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('startBtn').disabled = false;
  };

  // Save
  document.getElementById('saveBtn').onclick = async () => {
    document.getElementById('clickSound').play();
    const note = document.getElementById('taskNote').value;
    await fetch('{{ url_for("session_save") }}', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ session_id: currentSessionId, note })
    });
    alert('Session saved!');
    resetTimer();
    location.reload();
  };

  // Reset
  document.getElementById('resetBtn').onclick = async () => {
    document.getElementById('clickSound').play();
    if (currentSessionId && confirm('Discard current session?')) {
      await fetch('{{ url_for("session_reset") }}', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ session_id: currentSessionId })
      });
    }
    resetTimer();
  };

  function resetTimer() {
    clearInterval(interval);
    remainingMs = totalMs;
    currentSessionId = null;
    updateTimerDisplay();
    updateProgressCircle();
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('saveBtn').disabled = true;
  }

  // Delete session
  async function deleteSession(id) {
    document.getElementById('clickSound').play();
    if (!confirm('Delete this session?')) return;
    const res = await fetch('{{ url_for("session_delete") }}', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ session_id: id })
    });
    if (res.ok) location.reload();
    else alert('Failed to delete.');
  }

  // Chat widget
  const chatToggle = document.getElementById('chat-toggle');
  const chatWidget = document.getElementById('chat-widget');
  const chatClose  = document.getElementById('chat-close');
  const log        = document.getElementById('chat-log');
  const input      = document.getElementById('chat-input');
  const sendBtn    = document.getElementById('chat-send');
  const analyzeBtn = document.getElementById('analyzeBtn');

  chatToggle.addEventListener('click', () => {
    chatWidget.classList.toggle('hidden');
    input.focus();
  });
  chatClose.addEventListener('click', () => {
    chatWidget.classList.add('hidden');
  });

  function appendUser(msg) {
    log.innerHTML += `<div class="user-msg">You: ${msg}</div>`;
    log.scrollTop = log.scrollHeight;
  }

  async function postChat(url, payload) {
    log.innerHTML += `<div class="bot-msg" id="bot-typing">Bot: </div>`;
    log.scrollTop = log.scrollHeight;
    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      const resp = data.response || '';
      const botEl = document.getElementById('bot-typing');
      let i = 0;
      const iv = setInterval(() => {
        botEl.textContent += resp[i] || '';
        if (i++ >= resp.length) clearInterval(iv);
      }, 50);
    } catch (e) {
      log.innerHTML += `<div class="error-msg">Error: ${e}</div>`;
      log.scrollTop = log.scrollHeight;
    }
  }

  sendBtn.addEventListener('click', () => {
    const text = input.value.trim();
    if (!text) return;
    appendUser(text);
    postChat("{{ url_for('chat.chat') }}", { message: text });
    input.value = '';
  });
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); sendBtn.click(); }
  });

  analyzeBtn.addEventListener('click', () => {
    appendUser('Analyze my last Pomodoro sessions');
    postChat("{{ url_for('chat.analyze_sessions') }}", {});
  });

  // initialize display
  updateTimerDisplay();
  updateProgressCircle();
</script>
{% endblock %}
