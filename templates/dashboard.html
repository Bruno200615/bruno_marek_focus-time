{% extends "base.html" %}
{% block content %}
<div class="dashboard">
  <h1>Welcome, {{ username }}! üçÖ</h1>

  <audio id="clickSound" src="{{ url_for('static', filename='click.wav') }}"></audio>

  <input type="text" id="taskNote" placeholder="What are you working on?">

  <div class="pomodoro-container">
    <div class="progress-ring">
      <svg id="progressSvg" width="180" height="180">
        <circle cx="90" cy="90" r="80" stroke="#ccc" stroke-width="10" fill="none" />
        <circle id="progressCircle" cx="90" cy="90" r="80" stroke="#4CAF50" stroke-width="10" fill="none"
          stroke-dasharray="502" stroke-dashoffset="0" />
      </svg>
      <div class="timer" id="timer">25:00:000</div>
    </div>

    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="stopBtn" disabled>Stop</button>
      <button id="saveBtn" disabled>Save</button>
      <button id="resetBtn">Reset</button>
    </div>
  </div>

  <h2>Your Sessions</h2>
{% if sessions %}
<table>
  <thead>
    <tr>
      <th>Started At</th>
      <th>Ended At</th>
      <th>Duration</th>
      <th>Stops</th>
      <th>Note</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for s in sessions %}
    <tr>
      <td>{{ s.started_at.strftime('%Y-%m-%d %H:%M') }}</td>
      <td>
        {% if s.ended_at %}
          {{ s.ended_at.strftime('%Y-%m-%d %H:%M') }}
        {% else %}
          In Progress
        {% endif %}
      </td>
      <td>
        {% if s.ended_at %}
          {% set total = (s.ended_at - s.started_at).seconds %}
          {{ (total // 60)|string }}m {{ (total % 60)|string }}s
        {% else %}
          --:--:--
        {% endif %}
      </td>
      <td>{{ s.events|selectattr('event_type','equalto','stop')|list|length }}</td>
      <td>{{ s.note }}</td>
      <td>
        <button onclick="deleteSession('{{ s.id }}')">Delete</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
  <p>No sessions recorded yet.</p>
{% endif %}

<div id="chat-toggle">üí¨</div>
<div id="chat-widget" class="hidden">
  <div id="chat-header">
    <span>Pomodoro Bot</span>
    <button id="chat-close">‚úï</button>
  </div>
  <div id="chat-log"></div>
  <div id="chat-input-area">
    <input id="chat-input" placeholder="Ask me..." />
    <button id="chat-send">Send</button>
  </div>
</div>

</div>
{% endblock %}

{% block scripts %}
<script>
    let totalMs = 25 * 60 * 1000;
    let remainingMs = totalMs;
    let interval = null;
    let currentSessionId = null;
    
    const timerDisplay = document.getElementById('timer');
    const progressCircle = document.getElementById('progressCircle');
    const radius = 80;
    const circumference = 2 * Math.PI * radius;
    progressCircle.style.strokeDasharray = circumference;
    
    function updateTimerDisplay() {
      let minutes = Math.floor(remainingMs / 60000);
      let seconds = Math.floor((remainingMs % 60000) / 1000);
      let ms = remainingMs % 1000;
      timerDisplay.textContent =
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}:${String(ms).padStart(3, '0')}`;
    }
    
    function updateProgressCircle() {
      const offset = circumference * (1 - remainingMs / totalMs);
      progressCircle.style.strokeDashoffset = offset;
    }
    
    function tick() {
      remainingMs -= 50;
      if (remainingMs <= 0) {
        clearInterval(interval);
        interval = null;
        remainingMs = 0;
      }
      updateTimerDisplay();
      updateProgressCircle();
    }
    
    // Start button
    document.getElementById('startBtn').onclick = async () => {
      const clickSound = document.getElementById('clickSound');
      clickSound.currentTime = 0;
      clickSound.play();
    
      if (!currentSessionId) {
        const res = await fetch('{{ url_for("session_start") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        currentSessionId = data.session_id;
      }
    
      if (!interval) {
        interval = setInterval(tick, 50);
      }
    
      document.getElementById('stopBtn').disabled = false;
      document.getElementById('startBtn').disabled = true;
    };
    
    // Stop button
    document.getElementById('stopBtn').onclick = async () => {
      document.getElementById('clickSound').play();
      clearInterval(interval);
      interval = null;
    
      // Send stop event to server
      await fetch('{{ url_for("session_stop") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: currentSessionId })
      });
    
      // Enable save and reset buttons
      document.getElementById('saveBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      document.getElementById('startBtn').disabled = false;
    };
    
    // Save button
    document.getElementById('saveBtn').onclick = async () => {
      document.getElementById('clickSound').play();
      const note = document.getElementById('taskNote').value;
      await fetch('{{ url_for("session_save") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: currentSessionId, note })
      });
      alert('Session saved!');
      resetTimer();
      location.reload(); // Reload to show updated session data
    };
    
    // Reset button
    document.getElementById('resetBtn').onclick = async () => {
      document.getElementById('clickSound').play();
      if (currentSessionId && confirm('Discard current session?')) {
        await fetch('{{ url_for("session_reset") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: currentSessionId })
        });
      }
      resetTimer();
    };
    
    function resetTimer() {
      clearInterval(interval);
      interval = null;
      remainingMs = totalMs;
      currentSessionId = null;
      updateTimerDisplay();
      updateProgressCircle();
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      document.getElementById('saveBtn').disabled = true;
    }
    
    async function deleteSession(sessionId) {
      clickSound.currentTime = 0;
    
      const confirmed = confirm('Are you sure you want to delete this session?');
      if (!confirmed) return;
    
      const res = await fetch('{{ url_for("session_delete") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: sessionId })
      });
    
      if (res.ok) {
        alert('Session deleted!');
        location.reload();
      } else {
        alert('Failed to delete session.');
      }
    }
    
    const chatToggle = document.getElementById('chat-toggle');
    const chatWidget = document.getElementById('chat-widget');
    const chatClose  = document.getElementById('chat-close');
    const log        = document.getElementById('chat-log');
    const input      = document.getElementById('chat-input');
    const sendBtn    = document.getElementById('chat-send');
    
    // Show/hide on toggle click
chatToggle.addEventListener('click', () => {
  chatWidget.classList.toggle('hidden');
  input.focus();
});

// Hide on ‚Äú‚úï‚Äù
chatClose.addEventListener('click', () => {
  chatWidget.classList.add('hidden');
});

// Send message when user clicks ‚ÄúSend‚Äù or presses Enter
function trySend() {
  const text = input.value.trim();
  if (!text) return;

  log.innerHTML += `<div class="user-msg">You: ${text}</div>`;
  input.value = '';
  log.scrollTop = log.scrollHeight;

  // Show the "Bot: typing..." status
  log.innerHTML += `<div class="bot-msg" id="bot-typing">Bot: </div>`;
  log.scrollTop = log.scrollHeight;

  fetch("{{ url_for('chat.chat') }}", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: text })
  })
  .then(r => r.ok ? r.json() : Promise.reject(r.statusText))
  .then(data => {
    const botResponse = data.response;
    const botTypingElement = document.getElementById('bot-typing');
    
    // Start the "live typing" animation
    let index = 0;
    botTypingElement.textContent = 'Bot: ';
    
    // Use a faster interval for smoother and quicker typing
    const typingInterval = setInterval(() => {
      botTypingElement.textContent += botResponse[index];
      index++;
      if (index === botResponse.length) {
        clearInterval(typingInterval);
      }
    }, 50); // Adjusted to 50ms for faster typing (feel free to make it smaller for even faster speed)
  })
  .catch(err => {
    log.innerHTML += `<div class="error-msg">Error: ${err}</div>`;
    log.scrollTop = log.scrollHeight;
  });
}

sendBtn.addEventListener('click', trySend);
input.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    trySend();
  }
});
    
    </script>
    
{% endblock %}
